import shodan
import mysql.connector
import sys

API_KEY = "W5fPS6yH7BFNAkQrlHT4YcsxaLrajCGr"
api = shodan.Shodan(API_KEY)
name = sys.argv[1]
results = api.search(name)

try:
    conn = mysql.connector.connect(user='dbuser', password='cybersecurity2', host='127.0.0.1', database='exploitdb')
    cursor = conn.cursor()
    if conn.is_connected():
        for i in results['matches']:
            hostnames = (str(i['hostnames']))
            hostnamestr = str(hostnames)[1:-1]
            domains = (str(i['domains']))
            domainstr = str(domains)[1:-1]
            mysql_query =  """INSERT INTO shodan (ip, name, hostnames, city, country, domains, org, os, port, isp) Values(%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)"""
            cursor.execute(mysql_query, (i["ip_str"], name, hostnamestr, i['location']['city'], i['location']['country_name'], domainstr, i['org'], i['os'], i['port'], i['isp']))
            conn.commit()
except Error as e:
    print ("Mysql error")
finally:
    if (conn.is_connected()):
        cursor.close()
        conn.close()
